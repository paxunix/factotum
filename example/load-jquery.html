<!DOCTYPE html>   <!-- We're HTML5 -->

<html>

<head>

<title>Load jQuery</title>

<meta charset="UTF-8">  <!-- no lang by default -->

<!-- Here we (ab)use meta tags to supply metadata for this Fcommand. -->

<!-- Author's name and or email.  Required. -->
<meta name="author" content="paxunix@gmail.com">

<!-- Description of what this Fcommand does.  Required. -->
<meta name="description" content="Loads jQuery into the current page">

<!-- The string from navigator.language is used to find the most
appropriate tags when looking up localizable string content to be presented
to the user.  Required. -->
<meta name="description" lang="fr" content="Faire la chose en franÃ§ais">

<!-- Unique identifier for this Fcommand.  Looks like a guid, and is treated
     as though it is unique across all Fcommands.  Required. -->
<meta name="guid" content="21eddb42-7c5b-4437-8b7a-f08df5ef3479">

<!-- Command names used to invoke this Fcommand.  Delimited by spaces or
commas.  Required. -->
<meta name="keywords" content="jq,loadjq">

<!-- URL from which to download this Fcommand.  Optional. -->
<meta name="downloadUrl" content="http://example.com/load-jquery.html">

<!-- URL to check for a new version of this Fcommand.  Can return a document
     with only the <head><meta name="version"></head> markup.  Optional. -->
<meta name="updateUrl" content="http://example.com/load-jquery.html">

<!-- Version of this Fcommand.  Required.  Validated against
     semantic versionning:  http://semver.org/ -->
<meta name="version" content="1.2.3">

<!-- Context in which the Fcommand's javascript is run.

If "bg", the code is evaluated within the background page and thus has no
access to the page's DOM or javascript.  This is intended for Fcommands that
only need to access to chrome.* APIs and nothing else.

All other values equate to evaluating the code within the page and have
access to page's JS and DOM.  It can pass data to the Fcommand's "bgCode"
template script which will be run in the background page.  Optional.
-->
<meta name="context" content="page">

<!-- Specify the favicon for this Fcommand.  Optional.  -->
<link rel="icon" type="image/png" href="http://example.com/favicon.png">

</head>

<body>

<!-- The help for this Fcommand is inside a <template>.  A popup window will
     be shown by the background script when the Fcommand is invoked with
     -help.

     There can be any content in here that you wish.  Factotum loads its own
     styling for the help document and also adds a DISMISS button at the
     bottom.
     -->
<template id="help" lang="en">
  <h2>NAME</h2>
  <div class="indented pretty">
    jq, loadjq - load jQuery into the page's main frame
  </div>
  <h2>SYNOPSIS</h2>
  <div class="indented pretty">
    jq [<span class="opt">--min</span>] [<span class="opt">--version</span> <span class="optarg">v</span>] [<span class="opt">--delay</span> <span class="optarg">[sec]</span>] [<span class="opt">--error</span> <span class="optarg">[msg]</span>]
  </div>
  <h2>DESCRIPTION</h2>
  <div class="indented pretty">
    Loads jQuery into the page's main frame.  If <span class="opt">--version</span> is not given, loads 2.1.1.
    <p>
    With <span class="opt">--min</span>, the minified Javascript for the requested version will be loaded.
    <p>
    <span class="opt">--delay</span> <span class="optarg">[sec]</span> specifies the number of seconds to wait before loading jQuery into the page.  Default=5.
    <p>
    <span class="opt">--throw</span> <span class="optarg">msg</span> specifies an error message to throw before loading jQuery (intended for testing).
    <p>
    <span class="opt">--bgthrow</span> <span class="optarg">msg</span> specifies an error message to throw from the bg context (after loading jQuery) (intended for testing).
    <p>
    <span class="opt">--fail</span> <span class="optarg">msg</span> specifies an error message to pass to onFailure() (intended for testing)..
  </div>
</template>

<!--
This block is the opts={} declaration for the options parser.  It must
be a <template> with id=getopt.

This is extracted by id in the bg script and used to parse the Fcommand
command line.  The object returned by getopt is made available within
Factotum.runCommand().
-->

<template id="getopt">
<!--
  You can have regular HTML comments in here.  The textContent of this
  template is used as the JSON optspec.
  See GetOpt.js for the spec.

  You can even wrap it in a <script> so that your editor's syntax
  highlighting will highlight the JSON.

  You can't embed Javascript comments, though.
-->
<script>
{
  "version": {
    "type": "value",
    "default": "2.1.1"
  },
  "min": {
    "type": "boolean",
    "default": false,
    "aliases": [ "minify", "minified" ]
  },
  "delay": {
    "type": "value",
    "default": 5
  },
  "throw": {
    "type": "value"
  },
  "bgthrow": {
    "type": "value"
  },
  "fail": {
    "type": "value"
  }
}
</script>
</template>
<script>
/*
   Inline script blocks are run on import of this document into the page.
   Invoke your Fcommand code here by passing it to Factotum.runCommand().
   You _can_ run any code you want in a <script> block, but for it to
   be treated like an Fcommand, it needs to be called via runCommand().

   You must call onSuccess() once your Fcommand code has completed
   successfully.  Any object you pass to it will be passed to the bg code
   (if any) for this Fcommand when it is run in the background page after
   onSuccess() is called.

   Call onFailure() or throw an exception if you want to surface (and
   record) the error via the Factotum extension.  The object you pass
   it can be any Error object, or a string.  NOTE:  if calling onFailure(),
   you need to return immediately after, since it does not prevent further
   processing.
*/
function loadJquery(transferObj, onSuccess, onFailure) {

  var opts = transferObj.get("cmdlineOptions");

  console.log("transferObj: ", transferObj);

  // For forcing a failure
  if (opts.throw)
  {
      throw opts.throw;
  }

  // For pretending failure
  if (opts.fail)
  {
      onFailure(opts.fail);
      return;
  }

  var url = "https://code.jquery.com/jquery-" +
      opts.version +
      (opts.min ? ".min" : "") + ".js";

  opts.delay = opts.delay || 0;

  var s = document.createElement("script");
  s.src = url;
  s.onload = function () {
      // No need to keep the script around once it has run
      s.parentNode.removeChild(s);

      // Demonstrate that you can call onSuccess() in the future.
      // This Fcommand will not be allowed to re-run within its parent
      // document until onSuccess() or onFailure() has been called (or an
      // exception thrown).
      window.setTimeout(function () {
          console.log("calling onSuccess");

          onSuccess({ jqueryVersion: jQuery.fn.jquery });
        }, opts.delay * 1000);

      console.log(`Sleeping ${opts.delay} seconds before loading jQuery...`);
  };
  s.onerror = function (e) {
      // No need to keep the script around once it has run
      s.parentNode.removeChild(s);

      // NOTE:  since this is in the error handler for the script element,
      // throwing will not result in the failure being caught by
      // runCommand() because that execution context is already torn down.
      // Thus, you have to call onFailure() to allow Factotum to clean up
      // this Fcommand.  The throw is just for fun.
      var msg = "Failed to load jquery";
      onFailure(msg);
      throw Error(msg);
  };

  // NOTE:  this will NOT work if the page on which this Fcommand is running
  // has a CSP that disallows the load from jquery.com (e.g. github.com).
  // It might be an interesting exercise to see if that can be detected, and
  // then the content instead loaded via bgCode and injected straight into
  // the page.
  (document.head || document.documentElement).appendChild(s);
} // loadJquery

if (window.Factotum && Factotum.runCommand)
  Factotum.runCommand(loadJquery);
else
  throw Error("Factotum not enabled");
</script>

<!--
This element contains Javascript that will be run in the background page
if your Fcommand passed a non-null object to onSuccess().

It is wrapped in a Function that takes a single object parameter (the
one that your Fcommand passed to onSuccess()).

It must be a <template> with an ID of "bgCode".
-->
<template id="bgCode">
  <!-- You can wrap it in a <script> tag to make your editor's highlighter
    happy.  The textContent of this node will be parsed as Javascript and
    comprise the body of the function executed in the background page when
    the Fcommand calls onSuccess().

    !!!NOTE!!!:  this code runs with the full permissions of the Factotum
    extension.

    The code becomes the body of a function and is passed:  transferObject,
    onSuccess, and onFailure.

    transferObject is a TransferObject and contains (amongst other things) a
    "bgData" key whose value is the data passed to the Fcommand's onSuccess
    callback.  XXX:  document WTF is a TransferObject.

   You must call onSuccess() once your Fcommand bg code has completed
   successfully.

   Call onFailure() or throw an exception if you want to surface (and
   record) an error from your bg code.  The object you pass it can be any
   Error object, or a string.  NOTE:  if calling onFailure(), you need to
   return immediately after, since it does not prevent further processing.
  -->
<script>
console.log("Running in bg with:", transferObj);
var opts = transferObj.get("cmdlineOptions");

if (opts.bgthrow)
{
  throw opts.bgthrow;
}

chrome.notifications.create(
    "",
    {
        type: "basic",
        iconUrl: chrome.runtime.getURL("icons/md/info.png"),
        title: "Loaded jQuery",
        message: "Version " + transferObj.get("bgData").jqueryVersion,
    },
    function() { onSuccess(); }
);
</script>
</template>

</body>
</html>
